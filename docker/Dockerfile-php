# docker/Dockerfile-fpm
FROM php:8.2-fpm-bookworm

# Évite les prompts (tzdata, etc.)
ENV DEBIAN_FRONTEND=noninteractive

# ---- Système & dépendances de build ----
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      ca-certificates curl git wget unzip zip \
      sudo ssh locales acl \
      build-essential \
      zlib1g-dev libzip-dev \
      libxml2-dev \
      libicu-dev \
      libpng-dev libjpeg62-turbo-dev libfreetype6-dev libwebp-dev \
    ; \
    rm -rf /var/lib/apt/lists/*

# ---- Extensions PHP ----
RUN set -eux; \
    docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp; \
    docker-php-ext-install -j"$(nproc)" \
      pdo_mysql \
      soap \
      zip \
      opcache \
      gd \
      intl

# ---- Config PHP ----
COPY build/php/opcache.ini /usr/local/etc/php/conf.d/
COPY build/php/custom.ini  /usr/local/etc/php/conf.d/

# ---- Composer v2 ----
COPY --from=composer:2 /usr/bin/composer /usr/local/bin/composer

# ---- Utilisateur & permissions ----
RUN set -eux; \
    usermod -u 1000 www-data; \
    usermod -a -G www-data root; \
    mkdir -p /var/www /var/www/.composer; \
    chown -R www-data:www-data /var/www /var/www/.composer

# ---- App ----
WORKDIR /var/www/project
COPY . /var/www/project
